-------------------------------------------------------------------------------
-- Tiered Pure Type Systems
--
-------------------------------------------------------------------------------

module Tiered where

open import Data.Nat using (â„•; suc; pred; _<_; _â‰¤?_)
open import Data.Unit using (âŠ¤)
open import Data.Empty using (âŠ¥)
open import Data.String using (String)
open import Data.Sum using (_âŠŽ_)
open import Relation.Nullary using (yes; no; Â¬_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)
open import Relation.Binary.Definitions using (DecidableEquality)

-------------------------------------------------------------------------------
-- Grammar (with DeBruijn Indices and explicit sort annotations)

data ð•‹ : Set where
  s : â„• â†’ ð•‹ -- make prefix?
  fâŸ¨_â™¯_âŸ© : â„• â†’ â„• â†’ ð•‹
  bâŸ¨_â™¯_âŸ© : â„• â†’ â„• â†’ ð•‹
  Î»Ë¢_âˆ·_â‡’_ : â„• â†’ ð•‹ â†’ ð•‹ â†’ ð•‹
  Î Ë¢_âˆ·_â‡’_ : â„• â†’ ð•‹ â†’ ð•‹ â†’ ð•‹
  _Â§_Â§_ : ð•‹ â†’ â„• â†’ ð•‹ â†’ ð•‹

data ð• : Set where
  _â™¯_ : â„• â†’ â„• â†’ ð•

_â‰Ÿ_ : DecidableEquality ð•
(x â™¯ i) â‰Ÿ (y â™¯ j) with x Data.Nat.â‰Ÿ y with i Data.Nat.â‰Ÿ j
...                  | yes refl          | yes refl = yes refl
...                  | no prf            | _        = no Î» { refl â†’ prf refl }
...                  | _                 | no prf   = no Î» { refl â†’ prf refl } 

-------------------------------------------------------------------------------
-- Substitution and Lifting

lift-map : (â„• â†’ â„•) â†’ â„• â†’ ð•‹ â†’ ð•‹
lift-map f = go where
  go : â„• â†’ ð•‹ â†’ ð•‹
  go x (s i) = s i
  go x bâŸ¨ y â™¯ i âŸ© = bâŸ¨ y â™¯ i âŸ©
  go x fâŸ¨ y â™¯ i âŸ© with x â‰¤? y
  ...             | yes _ = fâŸ¨ f y â™¯ i âŸ©
  ...             | no  _ = fâŸ¨ y â™¯ i âŸ©
  go x (Î»Ë¢ i âˆ· m â‡’ n) = Î»Ë¢ i âˆ· go x m â‡’ go (suc x) n
  go x (Î Ë¢ i âˆ· a â‡’ b) = Î Ë¢ i âˆ· go x a â‡’ go (suc x) b 
  go x (m Â§ i Â§ n) = go x m Â§ i Â§ go x n

â†‘ : ð•‹ â†’ ð•‹
â†‘ = lift-map suc 0

â†“ : ð•‹ â†’ ð•‹
â†“ = lift-map pred 0

_[_/_] : ð•‹ â†’ ð•‹ â†’ ð• â†’ ð•‹
s i [ n / y ] = s i
bâŸ¨ x â™¯ i âŸ© [ n / y ] = bâŸ¨ x â™¯ i âŸ©
fâŸ¨ x â™¯ i âŸ© [ n / y â™¯ j ] with (x â™¯ i) â‰Ÿ (y â™¯ j) 
...                      | yes _  = n
...                      | _ = fâŸ¨ x â™¯ i âŸ©
(Î»Ë¢ i âˆ· a â‡’ m) [ n / y â™¯ j ] = Î»Ë¢ i âˆ· (a [ n / y â™¯ j ]) â‡’ (m [ â†‘ n / (suc y) â™¯ j ])
(Î Ë¢ i âˆ· a â‡’ b) [ n / y â™¯ j ] = Î Ë¢ i âˆ· (a [ n / y â™¯ j ]) â‡’ (b [ â†‘ n / (suc y) â™¯ j ])
(mâ‚ Â§ i Â§ mâ‚‚) [ n / y ] = (mâ‚ [ n / y ]) Â§ i Â§ (mâ‚‚ [ n / y ])

_[_/_]áµ‡ : ð•‹ â†’ ð•‹ â†’ ð• â†’ ð•‹ 
s j [ n / x ]áµ‡ = s j
fâŸ¨ y â™¯ j âŸ© [ n / x ]áµ‡ = fâŸ¨ y â™¯ j âŸ©
bâŸ¨ y â™¯ j âŸ© [ n / x â™¯ i ]áµ‡ with (y â™¯ j) â‰Ÿ (x â™¯ i)
...                          | yes _ = n
...                          | no _ = bâŸ¨ y â™¯ j âŸ©
(Î»Ë¢ j âˆ· a â‡’ m) [ n / x â™¯ i ]áµ‡ = Î»Ë¢ j âˆ· (a [ n / x â™¯ i ]áµ‡) â‡’ (m [ â†‘ n / (suc x) â™¯ i ]áµ‡)
(Î Ë¢ j âˆ· a â‡’ b) [ n / x â™¯ i ]áµ‡ = Î Ë¢ j âˆ· (a [ n / x â™¯ i ]áµ‡) â‡’ (b [ â†‘ n / (suc x) â™¯ i ]áµ‡)
(mâ‚ Â§ j Â§ mâ‚‚) [ n / x ]áµ‡ = (mâ‚ [ n / x ]áµ‡) Â§ j Â§ (mâ‚‚ [ n / x ]áµ‡)

_[_/0â™¯_] : ð•‹ â†’ ð•‹ â†’ â„• â†’ ð•‹
m [ n /0â™¯ i ] = â†“ (m [ â†‘ n / 0 â™¯ i ]áµ‡)

-------------------------------------------------------------------------------
-- Î²-Reduction

data _âŸ¶áµ‡_ : ð•‹ â†’ ð•‹ â†’ Set where
  Î²-rule : {i : â„•} â†’ {a m n : ð•‹} â†’
    ((Î»Ë¢ i âˆ· a â‡’ m) Â§ i Â§ n) âŸ¶áµ‡ (m [ n /0â™¯ i ])
  comp-piâ‚ : {i : â„•} â†’ {a b a' : ð•‹} â†’
    a âŸ¶áµ‡ a' â†’
    (Î Ë¢ i âˆ· a â‡’ b) âŸ¶áµ‡ (Î Ë¢ i âˆ· a' â‡’ b)
  comp-piâ‚‚ : {i : â„•} â†’ {a b b' : ð•‹} â†’
    b âŸ¶áµ‡ b' â†’
    (Î Ë¢ i âˆ· a â‡’ b) âŸ¶áµ‡ (Î Ë¢ i âˆ· a â‡’ b')
  comp-lamâ‚ : {i : â„•} â†’ {a b a' : ð•‹} â†’
    a âŸ¶áµ‡ a' â†’
    (Î»Ë¢ i âˆ· a â‡’ b) âŸ¶áµ‡ (Î»Ë¢ i âˆ· a' â‡’ b)
  comp-lamâ‚‚ : {i : â„•} â†’ {a b b' : ð•‹} â†’
    b âŸ¶áµ‡ b' â†’
    (Î»Ë¢ i âˆ· a â‡’ b) âŸ¶áµ‡ (Î»Ë¢ i âˆ· a â‡’ b')
  comp-appâ‚ : {i : â„•} â†’ {a b a' : ð•‹} â†’
    a âŸ¶áµ‡ a' â†’
    (a Â§ i Â§ b) âŸ¶áµ‡ (a' Â§ i Â§ b)
  comp-appâ‚‚ : {i : â„•} â†’ {a b b' : ð•‹} â†’
    b âŸ¶áµ‡ b'
    â†’ (a Â§ i Â§ b) âŸ¶áµ‡ (a Â§ i Â§ b')

data _â† áµ‡_ : ð•‹ â†’ ð•‹ â†’ Set where
  Î²-refl : {i : â„•} â†’ {m : ð•‹} â†’ m â† áµ‡ m
  Î²-step : {i : â„•} â†’ {m n n' : ð•‹} â†’ m âŸ¶áµ‡ n â†’ n â† áµ‡ n' â†’ m â† áµ‡ n'

â† áµ‡-trans : {m n p : ð•‹} â†’
  m â† áµ‡ n â†’
  n â† áµ‡ p â†’
  m â† áµ‡ p
â† áµ‡-trans Î²-refl np = np
â† áµ‡-trans (Î²-step {i} mn nn') np = Î²-step {i} mn (â† áµ‡-trans nn' np)

-------------------------------------------------------------------------------
-- Typing Inference

data â„‚ : Set where
  âˆ… : â„‚
  _,_âˆ·_ : â„‚ â†’ ð• â†’ ð•‹ â†’ â„‚

data _âˆ‰_ : ð• â†’ â„‚ â†’ Set where
  âˆ‰âˆ… : {x : ð•} â†’ x âˆ‰ âˆ…
  âˆ‰Î“ : {x y : ð•} â†’ {Î“ : â„‚} â†’ {a : ð•‹} â†’
    x âˆ‰ Î“ â†’
    x â‰¡ y â†’
    x âˆ‰ (Î“ , y âˆ· a)

_[_/_]á¶œ : â„‚ â†’ ð•‹ â†’ ð• â†’ â„‚
âˆ… [ _ / _ ]á¶œ = âˆ…
(Î“ , x âˆ· a) [ n / y ]á¶œ = (Î“ [ n / y ]á¶œ) , x âˆ· (a [ n / y ])

_âˆ˜_ : â„‚ â†’ â„‚ â†’ â„‚
Î“ âˆ˜ âˆ… = Î“
Î“ âˆ˜ (Î” , x âˆ· a) = (Î“ âˆ˜ Î”) , x âˆ· a

record Spec : Setâ‚ where
  field
    t : â„•
    rule : â„• â†’ â„• â†’ Set

data _âˆ¥_âŠ¢_âˆ·_ : Spec â†’ â„‚ â†’ ð•‹ â†’ ð•‹ â†’ Setâ‚ where

  axiom : {ð•Š : Spec} {i : â„•} â†’
    i < Spec.t ð•Š â†’
    -----------------------------------
    ð•Š âˆ¥ âˆ… âŠ¢ s i âˆ· s (suc i)

  var-intro : {ð•Š : Spec} â†’ {x i : â„•} â†’ {Î“ : â„‚} â†’ {a : ð•‹} â†’
    (x â™¯ i) âˆ‰ Î“ â†’
    ð•Š âˆ¥ Î“ âŠ¢ a âˆ· s i â†’
    -----------------------------------
    ð•Š âˆ¥ (Î“ , x â™¯ i âˆ· a) âŠ¢ fâŸ¨ x â™¯ i âŸ© âˆ· a

  sort-weaken : {ð•Š : Spec} â†’ {x i j : â„•} â†’ {Î“ : â„‚} â†’ {b : ð•‹} â†’
    (x â™¯ i) âˆ‰ Î“ â†’
    ð•Š âˆ¥ Î“ âŠ¢ s j âˆ· s (suc j) â†’
    ð•Š âˆ¥ Î“ âŠ¢ b âˆ· s i â†’
    -----------------------------------
    ð•Š âˆ¥ (Î“ , x â™¯ i âˆ· b) âŠ¢ s j âˆ· s (suc j)

  var-weaken : {ð•Š : Spec} â†’ {x i y j : â„•} â†’ {Î“ : â„‚} â†’ {a b : ð•‹} â†’
    (y â™¯ j) âˆ‰ Î“ â†’
    ð•Š âˆ¥ Î“ âŠ¢ fâŸ¨ x â™¯ i âŸ© âˆ· a â†’
    ð•Š âˆ¥ Î“ âŠ¢ b âˆ· s j â†’
    -----------------------------------
    ð•Š âˆ¥ (Î“ , y â™¯ j âˆ· b) âŠ¢ fâŸ¨ x â™¯ i âŸ© âˆ· a

  pi-intro : {ð•Š : Spec} â†’ {x i j : â„•} â†’ {Î“ : â„‚} â†’ {a b : ð•‹} â†’
    Spec.rule ð•Š i j â†’
    ð•Š âˆ¥ Î“ âŠ¢ a âˆ· s i â†’
    ð•Š âˆ¥ (Î“ , x â™¯ i âˆ· a) âŠ¢ b [ fâŸ¨ x â™¯ i âŸ© /0â™¯ i ] âˆ· s j â†’
    -----------------------------------
    ð•Š âˆ¥ Î“ âŠ¢ Î Ë¢ i âˆ· a â‡’ b âˆ· s j

  abstr : {ð•Š : Spec} â†’ {x i j : â„•} â†’ {Î“ : â„‚} â†’ {m a b : ð•‹} â†’
    ð•Š âˆ¥ (Î“ , x â™¯ i âˆ· a) âŠ¢ m [ fâŸ¨ x â™¯ i âŸ© /0â™¯ i ] âˆ· (b [ fâŸ¨ x â™¯ i âŸ© /0â™¯ i ]) â†’
    ð•Š âˆ¥ Î“ âŠ¢ Î Ë¢ i âˆ· a â‡’ b âˆ· s j â†’
    -----------------------------------
    ð•Š âˆ¥ Î“ âŠ¢ (Î»Ë¢ i âˆ· a â‡’ m) âˆ· (Î Ë¢ i âˆ· a â‡’ b)

  app : {ð•Š : Spec} â†’ {i : â„•} â†’ {Î“ : â„‚} â†’ {m n a b c : ð•‹} â†’
    ð•Š âˆ¥ Î“ âŠ¢ m âˆ· (Î Ë¢ i âˆ· a â‡’ b) â†’
    ð•Š âˆ¥ Î“ âŠ¢ n âˆ· a â†’
    c â‰¡ b [ n /0â™¯ i ] â†’
    -----------------------------------
    ð•Š âˆ¥ Î“ âŠ¢ (m Â§ i Â§ n) âˆ· c

  conv-red : {ð•Š : Spec} â†’ {i : â„•} â†’ {Î“ : â„‚} â†’ {m a b : ð•‹} â†’
    ð•Š âˆ¥ Î“ âŠ¢ m âˆ· a â†’
    ð•Š âˆ¥ Î“ âŠ¢ b âˆ· s i â†’
    a â† áµ‡ b â†’
    -----------------------------------
    ð•Š âˆ¥ Î“ âŠ¢ m âˆ· b
  
  conv-exp : {ð•Š : Spec} â†’ {i : â„•} â†’ {Î“ : â„‚} â†’ {m a b : ð•‹} â†’
    ð•Š âˆ¥ Î“ âŠ¢ m âˆ· a â†’
    ð•Š âˆ¥ Î“ âŠ¢ b âˆ· s i â†’
    b â† áµ‡ a â†’
    -----------------------------------
    ð•Š âˆ¥ Î“ âŠ¢ m âˆ· b


_âˆ¥_âŠ¬_âˆ·_ : (ð•Š : Spec) â†’ â„‚ â†’ ð•‹ â†’ ð•‹ â†’ Setâ‚
ð•Š âˆ¥ Î“ âŠ¬ m âˆ· a = Â¬ (ð•Š âˆ¥ Î“ âŠ¢ m âˆ· a)

-------------------------------------------------------------------------------
-- Well-formed Context

data WFC : (ð•Š : Spec) â†’ â„‚ â†’ Setâ‚ where
  âˆ…-wf : {ð•Š : Spec} â†’ WFC ð•Š âˆ…
  ext-wf : {ð•Š : Spec} â†’ {x i : â„•} â†’ {Î“ : â„‚} â†’ {a : ð•‹} â†’
    (x â™¯ i) âˆ‰ Î“ â†’
    ð•Š âˆ¥ Î“ âŠ¢ a âˆ· s i â†’
    WFC ð•Š Î“ â†’
    WFC ð•Š (Î“ , x â™¯ i âˆ· a)


 
