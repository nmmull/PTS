-------------------------------------------------------------------------------
-- Pure Type Systems
--
-------------------------------------------------------------------------------

open import Specification

module PTS (ğ•Š : Spec) where

open import Data.Nat using (â„•; suc; pred; _â‰¤?_)
open import Data.String using (String)
open import Relation.Nullary using (yes; no; Â¬_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; _â‰¢_)

-------------------------------------------------------------------------------
-- Grammar (with DeBruijn Indices and explicit sort annotations)

infix 30 s_
infix 22 Æ›_Â·_
infix 22 Î _Â·_
infix 22 _Â§_
data ğ•‹ : Set where
  s_ : Spec.Sort ğ•Š â†’ ğ•‹
  fâŸ¨_â™¯_âŸ© : â„• â†’ Spec.Sort ğ•Š â†’ ğ•‹
  bâŸ¨_âŸ© : â„• â†’ ğ•‹
  Æ›_Â·_ : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
  Î _Â·_ : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
  _Â§_ : ğ•‹ â†’ ğ•‹ â†’ ğ•‹

-------------------------------------------------------------------------------
-- Substitution and Lifting

lift-map : (â„• â†’ â„•) â†’ â„• â†’ ğ•‹ â†’ ğ•‹
lift-map f = go where
  go : â„• â†’ ğ•‹ â†’ ğ•‹
  go x (s i) = s i
  go x âŸ¨ y â™¯ i âŸ© with x â‰¤? y
  ...            | yes _ = âŸ¨ y â™¯ i âŸ©
  ...            | no _ = âŸ¨ y â™¯ i âŸ©
  go x (Æ› a Â· m) = Æ› go x a Â· go (suc x) m
  go x (Î  a Â· b) = Î  go x a Â· go (suc x) b 
  go x (m Â§ n) = go x m Â§ go x n

â†‘ : ğ•‹ â†’ ğ•‹
â†‘ = lift-map suc 0

â†“ : ğ•‹ â†’ ğ•‹
â†“ = lift-map pred 0

infix 25 _[_/_]
_[_/_] : ğ•‹ â†’ ğ•‹ â†’ â„• â†’ ğ•‹
s i [ n / y ] = s i
âŸ¨ x â™¯ i âŸ© [ n / y ] with x Data.Nat.â‰Ÿ y
...                     | yes _ = n
...                     | no _ =  âŸ¨ x â™¯ i âŸ©
(Æ› a Â· m) [ n / y ] = Æ› a [ n / y ] Â· m [ â†‘ n / suc y ]
(Î  a Â· b) [ n / y ] = Î  a [ n / y ] Â· b [ â†‘ n / suc y ]
(mâ‚ Â§ mâ‚‚) [ n / y ] = mâ‚ [ n / y ] Â§ mâ‚‚ [ n / y ]


infix 25 _[_]â°
_[_]â° : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
m [ n ]â° = â†“ (m [ â†‘ n / 0 ])

-------------------------------------------------------------------------------
-- Î²-Reduction

infix 15 _âŸ¶áµ‡_
data _âŸ¶áµ‡_ : ğ•‹ â†’ ğ•‹ â†’ Set where
  Î²-rule : âˆ€ {a m n} â†’
    (Æ› a Â· m) Â§ n âŸ¶áµ‡ m [ n ]â°
  comp-piâ‚ : âˆ€ {a b a'} â†’
    a âŸ¶áµ‡ a' â†’
    Î  a Â· b âŸ¶áµ‡ Î  a Â· b
  comp-piâ‚‚ : âˆ€ {a b b'} â†’
    b âŸ¶áµ‡ b' â†’
    Î  a Â· b âŸ¶áµ‡ Î  a Â· b'
  comp-lamâ‚ : âˆ€ {a b a'} â†’
    a âŸ¶áµ‡ a' â†’
    Æ› a Â· b âŸ¶áµ‡ Æ› a' Â· b
  comp-lamâ‚‚ : âˆ€ {a b b'} â†’
    b âŸ¶áµ‡ b' â†’
    Æ› a Â· b âŸ¶áµ‡ Æ› a Â· b'
  comp-appâ‚ : âˆ€ {a b a'} â†’
    a âŸ¶áµ‡ a' â†’
    a Â§ b âŸ¶áµ‡ a' Â§ b
  comp-appâ‚‚ : âˆ€ {a b b'} â†’
    b âŸ¶áµ‡ b' â†’
    a Â§ b âŸ¶áµ‡ a Â§ b'

data _â† áµ‡_ : ğ•‹ â†’ ğ•‹ â†’ Set where
  Î²-refl : âˆ€ {m} â†’ m â† áµ‡ m
  Î²-step : âˆ€ {m n n'} â†’ m âŸ¶áµ‡ n â†’ n â† áµ‡ n' â†’ m â† áµ‡ n'

â† áµ‡-trans : âˆ€ {m n p} â†’
  m â† áµ‡ n â†’
  n â† áµ‡ p â†’
  m â† áµ‡ p
â† áµ‡-trans Î²-refl np = np
â† áµ‡-trans (Î²-step mn nn') np = Î²-step mn (â† áµ‡-trans nn' np)

data _=áµ‡_ : ğ•‹ â†’ ğ•‹ â†’ Set where
  =áµ‡-refl : âˆ€ {m n} â†’ m â† áµ‡ n â†’ m =áµ‡ n
  =áµ‡-sym : âˆ€ {m n} â†’ m =áµ‡ n â†’ n =áµ‡ m
  =áµ‡-trans : âˆ€ {m n p} â†’ m =áµ‡ n â†’ n =áµ‡ p â†’ m =áµ‡ p

-------------------------------------------------------------------------------
-- Contexts

infix 22 _,_âˆ·_
data â„‚ : Set where
  âˆ… : â„‚
  _,_âˆ·_ : â„‚ â†’ â„• â†’ ğ•‹ â†’ â„‚

data _âˆ‰_ : â„• â†’ â„‚ â†’ Set where
  âˆ‰âˆ… : âˆ€ {x} â†’ x âˆ‰ âˆ…
  âˆ‰Î“ : âˆ€ {x y Î“ a} â†’
    x âˆ‰ Î“ â†’
    x â‰¢ y â†’
    x âˆ‰ (Î“ , y âˆ· a)

infix 25 _[_/_]á¶œ
_[_/_]á¶œ : â„‚ â†’ ğ•‹ â†’ â„• â†’ â„‚
âˆ… [ _ / _ ]á¶œ = âˆ…
(Î“ , x âˆ· a) [ n / y ]á¶œ = Î“ [ n / y ]á¶œ , x âˆ· a [ n / y ]


infix 25 _âˆ˜_
_âˆ˜_ : â„‚ â†’ â„‚ â†’ â„‚
Î“ âˆ˜ âˆ… = Î“
Î“ âˆ˜ (Î” , x âˆ· a) = Î“ âˆ˜ Î” , x âˆ· a

-------------------------------------------------------------------------------
-- Typing Inference

data _âŠ¢_âˆ·_ : â„‚ â†’ ğ•‹ â†’ ğ•‹ â†’ Setâ‚ where
  axiom : âˆ€ {i j} â†’ Spec.axiom ğ•Š i j â†’
    -----------------------------------
    âˆ… âŠ¢ s i âˆ· s j

  var-intro : âˆ€ {x i Î“ a} â†’
    x âˆ‰ Î“ â†’
    Î“ âŠ¢ a âˆ· s i â†’
    -----------------------------------
    Î“ , x âˆ· a âŠ¢ âŸ¨ x â™¯ i âŸ© âˆ· a

  sort-weaken : âˆ€ {x i j k Î“ b} â†’
    Spec.axiom ğ•Š j k â†’
    x âˆ‰ Î“ â†’
    Î“ âŠ¢ b âˆ· s i â†’
    Î“ âŠ¢ s j âˆ· s k â†’
    -----------------------------------
    Î“ , x âˆ· b âŠ¢ s j âˆ· s k

  var-weaken : âˆ€ {x y i j Î“ a b} â†’
    y âˆ‰ Î“ â†’
    Î“ âŠ¢ b âˆ· s j â†’
    Î“ âŠ¢ âŸ¨ x â™¯ i âŸ© âˆ· a â†’
    -----------------------------------
    Î“ , y âˆ· b âŠ¢ âŸ¨ x â™¯ i âŸ© âˆ· a

  pi-intro : âˆ€ {a i j k Î“ b} â†’
    Spec.rule ğ•Š i j k â†’
    Î“ âŠ¢ a âˆ· s i â†’
    (âˆ€ {x} â†’ x âˆ‰ Î“ â†’
      Î“ , x âˆ· a âŠ¢ b [ âŸ¨ x â™¯ i âŸ© ]â° âˆ· s j) â†’
    -----------------------------------
    Î“ âŠ¢ Î  a Â· b âˆ· s k

  abstr : âˆ€ {a i j Î“ m b} â†’
    Î“ âŠ¢ Î  a Â· b âˆ· s j â†’
    (âˆ€ {x} â†’ x âˆ‰ Î“ â†’
      Î“ , x âˆ· a âŠ¢ m [ âŸ¨ x â™¯ i âŸ© ]â° âˆ· b [ âŸ¨ x â™¯ i âŸ© ]â°) â†’
    -----------------------------------
    Î“ âŠ¢ Æ› a Â· m âˆ· Î  a Â· b

  app : âˆ€ {Î“ m n a b c} â†’
    Î“ âŠ¢ m âˆ· Î  a Â· b â†’
    Î“ âŠ¢ n âˆ· a â†’
    c â‰¡ b [ n ]â° â†’
    -----------------------------------
    Î“ âŠ¢ m Â§ n âˆ· c

  conv-red : âˆ€ {i Î“ m a b} â†’
    Î“ âŠ¢ m âˆ· a â†’
    Î“ âŠ¢ b âˆ· s i â†’
    a â† áµ‡ b â†’
    ----------------------------------- 
    Î“ âŠ¢ m âˆ· b
  
  conv-exp : âˆ€ {i Î“ m a b} â†’
    Î“ âŠ¢ m âˆ· a â†’
    Î“ âŠ¢ b âˆ· s i â†’
    b â† áµ‡ a â†’
    -----------------------------------
    Î“ âŠ¢ m âˆ· b

_âŠ¬_âˆ·_ : â„‚ â†’ ğ•‹ â†’ ğ•‹ â†’ Setâ‚
Î“ âŠ¬ m âˆ· a = Â¬ (Î“ âŠ¢ m âˆ· a)

-------------------------------------------------------------------------------
-- Well-formed Context

data WFC : â„‚ â†’ Setâ‚ where
  âˆ…-wf : WFC âˆ…
  ext-wf : âˆ€ {x i Î“ a} â†’
    x âˆ‰ Î“ â†’
    Î“ âŠ¢ a âˆ· s i â†’
    WFC Î“ â†’
    WFC (Î“ , x âˆ· a)
